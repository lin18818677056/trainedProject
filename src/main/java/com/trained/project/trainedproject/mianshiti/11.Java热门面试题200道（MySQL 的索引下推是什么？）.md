MySQL 的索引下推是什么？

# Java热门面试题200道

## 11. MySQL 的索引下推是什么？

### 概念定义

索引下推（Index Condition Pushdown，简称ICP）是MySQL 5.6版本引入的一种查询优化策略。它的主要目的是将查询的过滤条件尽可能地下推到存储引擎层，减少存储引擎返回给MySQL服务器层的记录数量，从而减少回表次数，提高查询性能。

### 工作原理

在没有索引下推的情况下，当使用非主键索引（二级索引）进行查询时，存储引擎会先根据索引查找记录，然后将结果返回给MySQL服务器层，服务器层再根据WHERE条件过滤数据，对于符合条件的记录再进行回表操作获取完整行数据。

而使用索引下推后，MySQL会将部分WHERE条件直接下推到存储引擎层，在存储引擎读取索引时就进行条件判断，过滤掉不满足条件的记录，从而减少回表次数。

### 使用场景

索引下推主要适用于以下场景：
1. 使用二级索引进行查询
2. WHERE条件中包含索引列和非索引列的组合条件
3. 存储引擎为InnoDB或MyISAM

### 示例说明

假设有一个用户表：
``` 
sql 
CREATE TABLE users (
   id INT PRIMARY KEY,
   name VARCHAR(50),
   age INT, 
   city VARCHAR(50), 
   INDEX idx_name_age (name, age) 
);
``` 
查询语句：
``` 
sql 
SELECT * FROM users WHERE name LIKE '张%' AND age > 25;
``` 


**未使用索引下推的情况：**
1. 存储引擎根据idx_name_age索引查找所有name LIKE '张%'的记录
2. 将所有这些记录返回给MySQL服务器层
3. 服务器层再过滤age > 25的记录
4. 对符合条件的记录进行回表操作获取完整行数据

**使用索引下推的情况：**
1. MySQL将name LIKE '张%' AND age > 25条件一起下推到存储引擎
2. 存储引擎在读取索引时就过滤掉age <= 25的记录
3. 只将同时满足name LIKE '张%' AND age > 25的记录返回给服务器层
4. 服务器层直接进行回表操作获取完整行数据

### 如何判断是否使用了索引下推

可以使用EXPLAIN命令查看执行计划：
- 在Extra列中看到"Using index condition"表示使用了索引下推
- 如果只看到"Using where"则表示未使用索引下推

### 优势

1. **减少回表次数**：通过在存储引擎层过滤数据，减少不必要的回表操作
2. **减少IO操作**：减少存储引擎与服务器层之间的数据传输
3. **提高查询性能**：特别是在索引选择性较低的情况下效果更明显

### 注意事项

1. 索引下推是MySQL的自动优化功能，无需手动开启（5.6版本后默认启用）
2. 只对二级索引有效，对主键索引无效
3. 不适用于覆盖索引的情况，因为不需要回表
4. 只适用于InnoDB和MyISAM存储引擎

索引下推是MySQL查询优化的重要特性之一，在实际开发中理解其原理有助于编写更高效的SQL语句。
